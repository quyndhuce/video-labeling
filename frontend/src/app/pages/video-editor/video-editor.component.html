<!-- Top Toolbar -->
<div class="editor-toolbar">
  <div class="toolbar-left">
    <button mat-icon-button (click)="goBack()" matTooltip="Back">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <div class="file-name">
      <mat-icon>movie</mat-icon>
      <span>{{ video?.original_name }}</span>
    </div>
  </div>
  <div class="toolbar-center">
    <div class="step-tabs">
      <button *ngFor="let step of steps; let i = index"
        class="step-tab" [class.active]="currentStep === i + 1"
        [class.completed]="currentStep > i + 1"
        (click)="setStep(i + 1)">
        <span class="step-num">{{ i + 1 }}</span>
        <span class="step-label">{{ step }}</span>
      </button>
    </div>
  </div>
  <div class="toolbar-right">
    <button mat-icon-button matTooltip="Settings" (click)="openSettings()">
      <mat-icon>settings</mat-icon>
    </button>
    <button mat-raised-button class="export-btn" [matMenuTriggerFor]="exportMenu" matTooltip="Export annotations">
      <mat-icon>download</mat-icon> Export
    </button>
    <mat-menu #exportMenu="matMenu">
      <button mat-menu-item (click)="exportAnnotations()">
        <mat-icon>movie</mat-icon>
        <span>Export This Video</span>
      </button>
      <button mat-menu-item (click)="exportProject()">
        <mat-icon>folder</mat-icon>
        <span>Export Entire Project</span>
      </button>
    </mat-menu>
  </div>
</div>

<!-- Review & Annotators Info Bar -->
<div class="info-bar" *ngIf="video">
  <div class="info-bar-left">
    <!-- Annotators -->
    <div class="annotators-info" *ngIf="video.annotator_details?.length">
      <mat-icon>people</mat-icon>
      <span class="info-label">Annotators:</span>
      <div class="annotator-chips">
        <div *ngFor="let u of video.annotator_details" class="annotator-chip"
             [style.background]="u.avatar_color || '#4A90D9'">
          <span class="chip-avatar">{{ u.full_name?.charAt(0) || u.username?.charAt(0) }}</span>
          <span class="chip-name">{{ u.full_name || u.username }}</span>
        </div>
      </div>
    </div>
    <!-- Reviewer -->
    <div class="reviewer-info" *ngIf="video.reviewer_details">
      <mat-icon>verified_user</mat-icon>
      <span class="info-label">Reviewers:</span>
      <ng-container *ngIf="video.reviewer_details_list?.length; else singleReviewer">
        <div class="annotator-chip" *ngFor="let reviewer of video.reviewer_details_list"
             [style.background]="reviewer.avatar_color || '#e8590c'">
          <span class="chip-avatar">{{ reviewer.full_name?.charAt(0) || reviewer.username?.charAt(0) }}</span>
          <span class="chip-name">{{ reviewer.full_name || reviewer.username }}</span>
          <!-- Show review status icon if they have reviewed -->
          <mat-icon *ngIf="getReviewerAction(reviewer.id) === 'approve'" 
                    class="review-icon approve">check_circle</mat-icon>
          <mat-icon *ngIf="getReviewerAction(reviewer.id) === 'reject'" 
                    class="review-icon reject">cancel</mat-icon>
        </div>
      </ng-container>
      <ng-template #singleReviewer>
        <div class="annotator-chip" *ngIf="video.reviewer_details"
             [style.background]="video.reviewer_details.avatar_color || '#e8590c'">
          <span class="chip-avatar">{{ video.reviewer_details.full_name?.charAt(0) || video.reviewer_details.username?.charAt(0) }}</span>
          <span class="chip-name">{{ video.reviewer_details.full_name || video.reviewer_details.username }}</span>
        </div>
      </ng-template>
    </div>
  </div>
  <div class="info-bar-right">
    <!-- Review Summary for multi-reviewer -->
    <span class="ed-review-summary" *ngIf="video.reviews?.length">
      {{ getReviewSummary() }}
    </span>
    <!-- Review Status -->
    <span class="ed-review-badge" [class]="video.review_status || 'not_submitted'">
      <mat-icon>{{ getReviewIcon(video.review_status) }}</mat-icon>
      {{ getReviewLabel(video.review_status) }}
    </span>
    <!-- Annotator: Submit for Review -->
    <button *ngIf="canSubmitForReview()" mat-stroked-button class="ed-submit-btn"
            (click)="submitForReview()">
      <mat-icon>send</mat-icon> Submit for Review
    </button>
    <!-- Reviewer: Approve / Reject / Change Vote -->
    <ng-container *ngIf="canReview()">
      <span *ngIf="hasUserReviewed()" class="ed-your-vote">
        Your vote: <strong>{{ getUserReview()?.action === 'approve' ? 'Approved' : 'Rejected' }}</strong>
      </span>
      <button mat-stroked-button class="ed-approve-btn" (click)="approveVideo()"
              [class.active]="getUserReview()?.action === 'approve'">
        <mat-icon>check_circle</mat-icon> {{ hasUserReviewed() ? 'Change to Approve' : 'Approve' }}
      </button>
      <button mat-stroked-button class="ed-reject-btn" (click)="showEditorRejectDialog = true"
              [class.active]="getUserReview()?.action === 'reject'">
        <mat-icon>cancel</mat-icon> {{ hasUserReviewed() ? 'Change to Reject' : 'Reject' }}
      </button>
      <button *ngIf="canWithdrawReview()" mat-stroked-button class="ed-withdraw-btn" (click)="withdrawReview()">
        <mat-icon>undo</mat-icon> Withdraw
      </button>
    </ng-container>
    <!-- Revoke Approval (admin/reviewer) -->
    <button *ngIf="canRevokeApproval()" mat-stroked-button class="ed-revoke-btn" (click)="revokeApproval()">
      <mat-icon>replay</mat-icon> Revoke Approval
    </button>
  </div>
</div>
<!-- Review Comment Banner -->
<div class="review-comment-banner" *ngIf="video?.review_comment"
     [class.rejected]="video.review_status === 'rejected'">
  <mat-icon>comment</mat-icon>
  <span>{{ video.review_comment }}</span>
</div>

<div class="editor-body" *ngIf="video">
  <!-- Hidden video for frame extraction (shared across steps) -->
  <video #segVideoPlayer [src]="video.url" style="display:none"></video>

  <!-- =================== STEP 1: VIDEO SEGMENTATION =================== -->
  <div class="step-content" *ngIf="currentStep === 1">
    <div class="editor-layout">
      <!-- Video Player -->
      <div class="player-section">
        <div class="video-container">
          <video #videoPlayer
            [src]="video.url"
            (loadedmetadata)="onVideoLoaded()"
            (timeupdate)="onTimeUpdate()"
            (click)="togglePlay()">
          </video>
          <div class="play-overlay" *ngIf="!isPlaying" (click)="togglePlay()">
            <mat-icon>play_arrow</mat-icon>
          </div>
        </div>

        <!-- Player Controls -->
        <div class="player-controls">
          <button mat-icon-button (click)="togglePlay()">
            <mat-icon>{{ isPlaying ? 'pause' : 'play_arrow' }}</mat-icon>
          </button>
          <span class="time-display">{{ formatTime(currentTime) }}</span>
          <div class="seek-bar" (click)="seekTo($event)" #seekBar>
            <div class="seek-fill" [style.width.%]="(currentTime / duration) * 100"></div>
            <div class="seek-thumb" [style.left.%]="(currentTime / duration) * 100"></div>
            <!-- Segment markers -->
            <div *ngFor="let seg of segments; let i = index" class="segment-marker"
              [style.left.%]="(seg.start_time / duration) * 100"
              [style.width.%]="((seg.end_time - seg.start_time) / duration) * 100"
              [style.background]="getSegmentColor(i) + '60'"
              [style.borderColor]="getSegmentColor(i)"
              [class.active]="selectedSegment?.id === seg.id"
              (click)="selectSegment(seg); $event.stopPropagation()">
            </div>
            <!-- Pending segment start marker -->
            <div *ngIf="segmentStart !== null" class="pending-start-marker"
              [style.left.%]="(segmentStart / duration) * 100"
              [style.background]="getSegmentColor(segments.length)">
            </div>
            <!-- Pending segment range (when both start and end are set) -->
            <div *ngIf="segmentStart !== null && segmentEnd !== null" class="pending-segment-marker"
              [style.left.%]="(getPendingStart() / duration) * 100"
              [style.width.%]="((getPendingEnd() - getPendingStart()) / duration) * 100"
              [style.background]="getSegmentColor(segments.length) + '50'"
              [style.borderColor]="getSegmentColor(segments.length)">
            </div>
          </div>
          <span class="time-display">{{ formatTime(duration) }}</span>
          <button mat-icon-button (click)="toggleMute()">
            <mat-icon>{{ isMuted ? 'volume_off' : 'volume_up' }}</mat-icon>
          </button>
        </div>

        <!-- Segment Actions -->
        <div class="segment-actions">
          <button mat-raised-button class="action-btn" (click)="markSegmentStart()">
            <mat-icon>first_page</mat-icon> Mark Start
          </button>
          <button mat-raised-button class="action-btn" (click)="markSegmentEnd()">
            <mat-icon>last_page</mat-icon> Mark End
          </button>
          <button mat-raised-button class="primary-btn" (click)="addSegment()" [disabled]="segmentStart === null">
            <mat-icon>add</mat-icon> Add Segment
          </button>
          <div class="spacer"></div>
          <button mat-raised-button class="action-btn" (click)="autoSplit()">
            <mat-icon>auto_fix_high</mat-icon> Auto Split
          </button>
        </div>
      </div>

      <!-- Resize Divider -->
      <div class="resize-divider" (mousedown)="startPanelResize($event)"></div>
      <!-- Segments Panel -->
      <div class="segments-panel" [style.width.px]="panelWidth">
        <div class="panel-header">
          <h3>Segments</h3>
          <span class="count-badge">{{ segments.length }}</span>
        </div>
        <div class="segments-list">
          <div *ngFor="let seg of segments; let i = index"
            class="segment-item" [class.active]="selectedSegment?.id === seg.id"
            (click)="selectSegment(seg)">
            <div class="seg-color" [style.background]="getSegmentColor(i)"></div>
            <div class="seg-info">
              <input class="seg-name-input" [(ngModel)]="seg.name"
                (blur)="updateSegmentName(seg)" (click)="$event.stopPropagation()">
              <span class="seg-time">{{ formatTime(seg.start_time) }} - {{ formatTime(seg.end_time) }}</span>
            </div>
            <button mat-icon-button (click)="deleteSegment(seg); $event.stopPropagation()">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          <div *ngIf="segments.length === 0" class="empty-segments">
            <p>No segments yet</p>
            <p class="hint">Use Mark Start/End to create segments</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Timeline -->
    <div class="timeline-section">
      <div class="timeline-header">
        <mat-icon>timeline</mat-icon>
        <span>Timeline</span>
      </div>
      <div class="timeline-track" #timelineTrack (click)="seekFromTimeline($event)">
        <div class="timeline-cursor" [style.left.%]="(currentTime / duration) * 100"></div>
        <div *ngFor="let seg of segments; let i = index"
          class="timeline-segment"
          [style.left.%]="(seg.start_time / duration) * 100"
          [style.width.%]="((seg.end_time - seg.start_time) / duration) * 100"
          [style.background]="getSegmentColor(i) + '80'"
          [style.borderColor]="getSegmentColor(i)"
          [class.active]="selectedSegment?.id === seg.id"
          (click)="selectSegment(seg); $event.stopPropagation()">
          <span class="tl-seg-name">{{ seg.name }}</span>
        </div>
        <!-- Pending segment start marker on timeline -->
        <div *ngIf="segmentStart !== null" class="timeline-pending-start"
          [style.left.%]="(segmentStart / duration) * 100"
          [style.background]="getSegmentColor(segments.length)">
        </div>
        <!-- Pending segment range on timeline -->
        <div *ngIf="segmentStart !== null && segmentEnd !== null"
          class="timeline-segment pending"
          [style.left.%]="(getPendingStart() / duration) * 100"
          [style.width.%]="((getPendingEnd() - getPendingStart()) / duration) * 100"
          [style.background]="getSegmentColor(segments.length) + '50'"
          [style.borderColor]="getSegmentColor(segments.length)">
          <span class="tl-seg-name">New Segment</span>
        </div>
        <!-- Time markers -->
        <div class="time-markers">
          <span *ngFor="let t of timeMarkers" class="time-marker" [style.left.%]="(t / duration) * 100">
            {{ formatTime(t) }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- =================== STEP 2: OBJECT SEGMENTATION =================== -->
  <div class="step-content" *ngIf="currentStep === 2">
    <div class="editor-layout">
      <!-- Canvas Section -->
      <div class="canvas-section">
        <div class="canvas-toolbar">
          <span class="segment-label" *ngIf="selectedSegment">
            {{ selectedSegment.name }} ({{ formatTime(selectedSegment.start_time) }} - {{ formatTime(selectedSegment.end_time) }})
          </span>
          <div class="brush-tools">
            <button mat-icon-button [class.active]="brushMode === 'draw' && !panMode"
              (click)="brushMode = 'draw'; panMode = false" matTooltip="Draw brush (B)">
              <mat-icon>brush</mat-icon>
            </button>
            <button mat-icon-button [class.active]="brushMode === 'erase' && !panMode"
              (click)="brushMode = 'erase'; panMode = false" matTooltip="Eraser (E)">
              <mat-icon>auto_fix_off</mat-icon>
            </button>
            <button mat-icon-button [class.active]="panMode"
              (click)="panMode = !panMode" matTooltip="Move / Pan (Space hold or H)">
              <mat-icon>pan_tool</mat-icon>
            </button>
            <div class="brush-size">
              <mat-icon>circle</mat-icon>
              <input type="range" min="5" max="80" [(ngModel)]="brushSize">
              <span>{{ brushSize }}px</span>
            </div>
            <button mat-icon-button (click)="clearCanvas()" matTooltip="Clear">
              <mat-icon>delete_sweep</mat-icon>
            </button>
          </div>
          <div class="canvas-actions">
            <button mat-raised-button class="primary-btn" (click)="runSegmentation()" [disabled]="segmenting">
              <mat-spinner *ngIf="segmenting" diameter="16"></mat-spinner>
              <mat-icon *ngIf="!segmenting">auto_awesome</mat-icon>
              {{ segmenting ? 'Processing...' : 'Segment' }}
            </button>
            <button *ngIf="selectedRegion" mat-raised-button class="action-btn update-btn" (click)="saveOrUpdateRegion()" [disabled]="!hasDrawing">
              <mat-icon>update</mat-icon> Update Region
            </button>
            <button *ngIf="!selectedRegion && hasDrawing" mat-raised-button class="action-btn" (click)="saveOrUpdateRegion()">
              <mat-icon>save</mat-icon> Save Region
            </button>
            <button mat-stroked-button class="new-obj-btn" (click)="startNewRegion()" matTooltip="Deselect current region and start a new one">
              <mat-icon>add_circle_outline</mat-icon> New Object
            </button>
          </div>
        </div>

        <div class="canvas-container" (wheel)="onCanvasWheel($event)">
          <div class="canvas-zoom-wrapper" [class.pan-active]="panMode || spaceHeld"
               [style.transform]="'scale(' + zoomLevel + ') translate(' + panX + 'px,' + panY + 'px)'"
               (mousedown)="onCanvasMouseDown($event)"
               (mousemove)="onCanvasMouseMove($event)"
               (mouseup)="onCanvasMouseUp($event)"
               (mouseleave)="onCanvasMouseUp($event)">
            <canvas #frameCanvas class="frame-canvas"></canvas>
            <canvas #drawCanvas class="draw-canvas"></canvas>
            <canvas #maskCanvas class="mask-canvas"></canvas>
          </div>

          <!-- Zoom controls -->
          <div class="zoom-controls">
            <button mat-icon-button (click)="zoomIn()" matTooltip="Zoom in">
              <mat-icon>zoom_in</mat-icon>
            </button>
            <span class="zoom-level">{{ (zoomLevel * 100).toFixed(0) }}%</span>
            <button mat-icon-button (click)="zoomOut()" matTooltip="Zoom out">
              <mat-icon>zoom_out</mat-icon>
            </button>
            <button mat-icon-button (click)="zoomReset()" matTooltip="Reset zoom" *ngIf="zoomLevel !== 1">
              <mat-icon>center_focus_strong</mat-icon>
            </button>
          </div>

          <!-- Frame navigation -->
          <div class="frame-nav">
            <button mat-icon-button (click)="prevFrame()" matTooltip="Previous frame">
              <mat-icon>skip_previous</mat-icon>
            </button>
            <span>Frame at {{ formatTime(frameTime) }}</span>
            <button mat-icon-button (click)="nextFrame()" matTooltip="Next frame">
              <mat-icon>skip_next</mat-icon>
            </button>
          </div>
        </div>

      </div>

      <!-- Resize Divider -->
      <div class="resize-divider" (mousedown)="startPanelResize($event)"></div>
      <!-- Regions Panel -->
      <div class="regions-panel" [style.width.px]="panelWidth">
        <div class="panel-header">
          <h3>Segments</h3>
        </div>
        <div class="mini-segments">
          <div *ngFor="let seg of segments; let i = index"
            class="mini-seg" [class.active]="selectedSegment?.id === seg.id"
            (click)="selectSegmentForAnnotation(seg)">
            <div class="seg-color" [style.background]="getSegmentColor(i)"></div>
            <span>{{ seg.name }}</span>
            <span class="region-count">{{ segmentRegionCounts[seg.id] || 0 }}</span>
          </div>
        </div>

        <div class="panel-header mt-16">
          <h3>Regions</h3>
          <span class="count-badge">{{ regions.length }}</span>
        </div>
        <div class="regions-list">
          <div *ngFor="let region of regions"
            class="region-item" [class.active]="selectedRegion?.id === region.id"
            (click)="selectRegion(region)">
            <input type="color" class="region-color-input" [ngModel]="region.color"
              (ngModelChange)="region.color = $event; updateRegionProps(region)"
              (click)="$event.stopPropagation()">
            <div class="region-info">
              <input class="seg-name-input" [(ngModel)]="region.label"
                (blur)="updateRegionProps(region)" (click)="$event.stopPropagation()">
              <span class="region-time">&#64; {{ formatTime(region.frame_time) }}</span>
            </div>
            <div class="region-actions">
              <mat-icon *ngIf="region.caption" class="has-caption" matTooltip="Has caption">description</mat-icon>
              <button mat-icon-button (click)="deleteRegion(region); $event.stopPropagation()">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
          <div *ngIf="regions.length === 0" class="empty-segments">
            <p>No regions yet</p>
            <p class="hint">Draw on the frame and click Segment</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- =================== STEP 3: CAPTIONING =================== -->
  <div class="step-content" *ngIf="currentStep === 3">
    <div class="editor-layout">
      <!-- Caption Editor -->
      <div class="caption-section">

        <!-- ===== SEGMENT-LEVEL CAPTIONS (when segment selected, no region) ===== -->
        <ng-container *ngIf="selectedSegment && !selectedRegion">
          <div class="caption-header">
            <h3>Segment Captioning: <span class="seg-name">{{ selectedSegment.name }}</span></h3>
          </div>

          <div class="caption-preview">
            <div class="segment-preview-video-wrap">
              <video #segmentPreviewVideo class="segment-preview-video"
                [src]="segmentPreviewSrc"
                (loadeddata)="onSegmentVideoLoaded()"
                (timeupdate)="onSegmentPreviewTimeUpdate()"
                (ended)="segmentPreviewPlaying = false"></video>
              <div class="seg-preview-controls">
                <button class="seg-play-btn" (click)="toggleSegmentPreview()">
                  <mat-icon>{{ segmentPreviewPlaying ? 'pause' : 'play_arrow' }}</mat-icon>
                </button>
                <div class="seg-progress-wrap" (click)="seekSegmentPreview($event)">
                  <div class="seg-progress-bar">
                    <div class="seg-progress-fill" [style.width.%]="segmentPreviewProgress"></div>
                  </div>
                </div>
                <span class="seg-time-label">{{ segmentPreviewCurrentLabel }} / {{ segmentPreviewDurationLabel }}</span>
              </div>
            </div>
          </div>

          <div class="caption-levels">
            <!-- Generate Contextual -->
            <div class="generate-all-bar">
              <button mat-raised-button class="generate-all-btn" (click)="generateAllSegmentCaptions()"
                      [disabled]="generatingAll">
                <mat-icon *ngIf="!generatingAll">auto_awesome</mat-icon>
                <mat-spinner *ngIf="generatingAll" diameter="18"></mat-spinner>
                {{ generatingAll ? 'Generating...' : 'Auto Generate Contextual (DAM)' }}
              </button>
            </div>

            <!-- L2 Contextual Caption -->
            <div class="caption-level">
              <div class="level-header">
                <div class="level-badge contextual">L2</div>
                <div>
                  <h4>Contextual Caption</h4>
                  <p>Describe the overall scene context in this segment</p>
                </div>
                <button mat-icon-button class="generate-btn" matTooltip="Auto generate with DAM"
                        (click)="generateSingleCaption('contextual')"
                        [disabled]="generatingContextual">
                  <mat-icon *ngIf="!generatingContextual">smart_toy</mat-icon>
                  <mat-spinner *ngIf="generatingContextual" diameter="18"></mat-spinner>
                </button>
              </div>
              <div class="bilingual-fields">
                <div class="lang-field">
                  <span class="lang-label">ðŸ‡¬ðŸ‡§ EN</span>
                  <mat-form-field appearance="outline">
                    <textarea matInput [(ngModel)]="segmentCaptionData.contextual_caption" rows="3"
                      placeholder="e.g., A busy intersection with vehicles and pedestrians during daytime"></textarea>
                  </mat-form-field>
                  <button mat-icon-button class="translate-btn" matTooltip="Translate EN â†’ VI"
                          (click)="translateField('contextual_caption', 'en_to_vi', 'segment')" [disabled]="translating">
                    <mat-icon>south</mat-icon>
                  </button>
                </div>
                <div class="lang-field">
                  <span class="lang-label">ðŸ‡»ðŸ‡³ VI</span>
                  <mat-form-field appearance="outline">
                    <textarea matInput [(ngModel)]="segmentCaptionData.contextual_caption_vi" rows="3"
                      placeholder="VD: Má»™t ngÃ£ tÆ° Ä‘Ã´ng Ä‘Ãºc vá»›i xe cá»™ vÃ  ngÆ°á»i Ä‘i bá»™ vÃ o ban ngÃ y"></textarea>
                  </mat-form-field>
                  <button mat-icon-button class="translate-btn" matTooltip="Translate VI â†’ EN"
                          (click)="translateField('contextual_caption', 'vi_to_en', 'segment')" [disabled]="translating">
                    <mat-icon>north</mat-icon>
                  </button>
                </div>
              </div>
            </div>

            <!-- L3 Knowledge Caption -->
            <div class="caption-level">
              <div class="level-header">
                <div class="level-badge knowledge">L3</div>
                <div>
                  <h4>Related Knowledge</h4>
                  <p>Select knowledge from Knowledge Base</p>
                </div>
              </div>
              <!-- Knowledge Base Selector -->
              <div class="kb-selector-row">
                <app-knowledge-base-selector
                  label="Related Knowledge"
                  placeholder="Search knowledge base..."
                  [(ngModel)]="segmentCaptionKBIds"
                  [multiple]="true"
                  [showQuickAdd]="true"
                  (selectionChange)="onSegmentKBSelectionChange($event)">
                </app-knowledge-base-selector>
              </div>
            </div>

            <!-- Combined Caption -->
            <div class="caption-level combined">
              <div class="level-header">
                <div class="level-badge combined-badge">âœ¦</div>
                <div>
                  <h4>Combined Caption</h4>
                  <p>Final combined description from contextual + knowledge</p>
                </div>
              </div>
              <div class="bilingual-fields">
                <div class="lang-field">
                  <span class="lang-label">ðŸ‡¬ðŸ‡§ EN</span>
                  <mat-form-field appearance="outline">
                    <textarea matInput [(ngModel)]="segmentCaptionData.combined_caption" rows="4"
                      placeholder="Combined description incorporating contextual and knowledge levels..."></textarea>
                  </mat-form-field>
                  <button mat-icon-button class="translate-btn" matTooltip="Translate EN â†’ VI"
                          (click)="translateField('combined_caption', 'en_to_vi', 'segment')" [disabled]="translating">
                    <mat-icon>south</mat-icon>
                  </button>
                </div>
                <div class="lang-field">
                  <span class="lang-label">ðŸ‡»ðŸ‡³ VI</span>
                  <mat-form-field appearance="outline">
                    <textarea matInput [(ngModel)]="segmentCaptionData.combined_caption_vi" rows="4"
                      placeholder="MÃ´ táº£ tá»•ng há»£p káº¿t há»£p cÃ¡c cáº¥p Ä‘á»™ contextual vÃ  knowledge..."></textarea>
                  </mat-form-field>
                  <button mat-icon-button class="translate-btn" matTooltip="Translate VI â†’ EN"
                          (click)="translateField('combined_caption', 'vi_to_en', 'segment')" [disabled]="translating">
                    <mat-icon>north</mat-icon>
                  </button>
                </div>
              </div>
              <div class="combine-actions">
                <button mat-stroked-button class="auto-combine-btn" (click)="autoCombineAndTranslate()"
                        [disabled]="translating || !canCombineSegmentCaptions()"
                        [matTooltip]="getSegmentCombineTooltip()">
                  <mat-spinner *ngIf="translating" diameter="16"></mat-spinner>
                  <mat-icon *ngIf="!translating">auto_awesome</mat-icon>
                  {{ translating ? 'Processing...' : 'Auto Combine & Translate' }}
                </button>
              </div>
            </div>

            <div class="caption-actions">
              <button mat-raised-button class="primary-btn" (click)="saveSegmentCaption()">
                <mat-icon>save</mat-icon> Save Segment Caption
              </button>
            </div>
          </div>
        </ng-container>

        <!-- ===== REGION-LEVEL CAPTION (when region is selected) ===== -->
        <ng-container *ngIf="selectedRegion">
          <div class="caption-header">
            <div class="caption-header-row">
              <h3>
                Captioning: <span [style.color]="selectedRegion.color">{{ selectedRegion.label }}</span>
                in {{ selectedSegment?.name }}
              </h3>
              <!-- Professional Category Selector -->
              <div class="category-dropdown-container">
                <button class="category-dropdown-trigger" (click)="showCategoryDropdown = !showCategoryDropdown"
                        [class.has-category]="selectedRegion?.category_id">
                  <span class="cat-color-indicator" *ngIf="selectedRegion?.category_id" 
                        [style.background]="getCategoryColor(selectedRegion?.category_id)"></span>
                  <span class="cat-label">{{ selectedRegion?.category_name || 'No category' }}</span>
                  <mat-icon class="dropdown-arrow">{{ showCategoryDropdown ? 'expand_less' : 'expand_more' }}</mat-icon>
                </button>
                
                <!-- Category Dropdown Panel -->
                <div class="category-dropdown-panel" *ngIf="showCategoryDropdown" (click)="$event.stopPropagation()">
                  <div class="cat-dropdown-header">
                    <span>Select Category</span>
                    <button class="cat-dropdown-close" (click)="showCategoryDropdown = false">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                  
                  <!-- Category List -->
                  <div class="cat-dropdown-list">
                    <div class="cat-dropdown-item" [class.active]="!selectedRegion?.category_id"
                         (click)="onCategoryChange(null); showCategoryDropdown = false">
                      <span class="cat-color-dot" style="background: #666"></span>
                      <span class="cat-item-name">No category</span>
                      <mat-icon *ngIf="!selectedRegion?.category_id" class="cat-check">check</mat-icon>
                    </div>
                    <div class="cat-dropdown-item" *ngFor="let cat of categories"
                         [class.active]="selectedRegion?.category_id === cat.id"
                         (click)="onCategoryChange(cat.id); showCategoryDropdown = false">
                      <span class="cat-color-dot" [style.background]="cat.color"></span>
                      <span class="cat-item-name">{{ cat.name }}</span>
                      <span class="cat-item-desc" *ngIf="cat.description">{{ cat.description }}</span>
                      <mat-icon *ngIf="selectedRegion?.category_id === cat.id" class="cat-check">check</mat-icon>
                    </div>
                  </div>
                  
                  <!-- Inline Add New Category -->
                  <div class="cat-add-inline">
                    <div class="cat-add-inline-header" (click)="showInlineCategoryAdd = !showInlineCategoryAdd">
                      <mat-icon>add_circle_outline</mat-icon>
                      <span>Add new category</span>
                      <mat-icon class="expand-icon">{{ showInlineCategoryAdd ? 'expand_less' : 'expand_more' }}</mat-icon>
                    </div>
                    <div class="cat-add-inline-form" *ngIf="showInlineCategoryAdd">
                      <div class="cat-add-row">
                        <input type="color" [(ngModel)]="newCategoryColor" class="cat-inline-color">
                        <input class="cat-inline-name" [(ngModel)]="newCategoryName" placeholder="Category name..." 
                               (keyup.enter)="addCategory(); showCategoryDropdown = false">
                        <button class="cat-inline-add-btn" (click)="addCategory(); showCategoryDropdown = false" 
                                [disabled]="!newCategoryName.trim()">
                          <mat-icon>add</mat-icon>
                        </button>
                      </div>
                      <input class="cat-inline-desc" [(ngModel)]="newCategoryDesc" placeholder="Description (optional)...">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="caption-preview">
            <div class="preview-canvas-wrap">
              <canvas #captionCanvas class="caption-canvas"></canvas>
            </div>
          </div>

          <div class="caption-levels">
            <!-- Generate Visual Button -->
            <div class="generate-all-bar">
              <button mat-raised-button class="generate-all-btn" (click)="generateAllCaptions()"
                      [disabled]="generatingAll || !selectedRegion?.segmented_mask">
                <mat-icon *ngIf="!generatingAll">auto_awesome</mat-icon>
                <mat-spinner *ngIf="generatingAll" diameter="18"></mat-spinner>
                {{ generatingAll ? 'Generating...' : 'Auto Generate Visual Caption (DAM)' }}
              </button>
            </div>

            <!-- L1 Visual Caption -->
            <div class="caption-level">
              <div class="level-header">
                <div class="level-badge visual">L1</div>
                <div>
                  <h4>Visual Caption</h4>
                  <p>Describe what the object looks like visually</p>
                </div>
                <button mat-icon-button class="generate-btn" matTooltip="Auto generate with DAM"
                        (click)="generateSingleCaption('visual')"
                        [disabled]="generatingVisual || !selectedRegion?.segmented_mask">
                  <mat-icon *ngIf="!generatingVisual">smart_toy</mat-icon>
                  <mat-spinner *ngIf="generatingVisual" diameter="18"></mat-spinner>
                </button>
              </div>
              <div class="bilingual-fields">
                <div class="lang-field">
                  <span class="lang-label">ðŸ‡¬ðŸ‡§ EN</span>
                  <mat-form-field appearance="outline">
                    <textarea matInput [(ngModel)]="captionData.visual_caption" rows="3"
                      placeholder="e.g., A red sedan car with tinted windows parked on the street"></textarea>
                  </mat-form-field>
                  <button mat-icon-button class="translate-btn" matTooltip="Translate EN â†’ VI"
                          (click)="translateField('visual_caption', 'en_to_vi')" [disabled]="translating">
                    <mat-icon>south</mat-icon>
                  </button>
                </div>
                <div class="lang-field">
                  <span class="lang-label">ðŸ‡»ðŸ‡³ VI</span>
                  <mat-form-field appearance="outline">
                    <textarea matInput [(ngModel)]="captionData.visual_caption_vi" rows="3"
                      placeholder="VD: Má»™t chiáº¿c Ã´ tÃ´ sedan mÃ u Ä‘á» vá»›i cá»­a kÃ­nh tá»‘i Ä‘áº­u trÃªn Ä‘Æ°á»ng"></textarea>
                  </mat-form-field>
                  <button mat-icon-button class="translate-btn" matTooltip="Translate VI â†’ EN"
                          (click)="translateField('visual_caption', 'vi_to_en')" [disabled]="translating">
                    <mat-icon>north</mat-icon>
                  </button>
                </div>
              </div>
            </div>

            <!-- L3 Knowledge Caption -->
            <div class="caption-level">
              <div class="level-header">
                <div class="level-badge knowledge">L3</div>
                <div>
                  <h4>Related Knowledge</h4>
                  <p>Select knowledge from Knowledge Base</p>
                </div>
              </div>
              <!-- Knowledge Base Selector -->
              <div class="kb-selector-row">
                <app-knowledge-base-selector
                  label="Related Knowledge"
                  placeholder="Search knowledge base..."
                  [(ngModel)]="captionKBIds"
                  [multiple]="true"
                  [showQuickAdd]="true"
                  (selectionChange)="onRegionKBSelectionChange($event)">
                </app-knowledge-base-selector>
              </div>
            </div>

            <!-- Combined Caption -->
            <div class="caption-level combined">
              <div class="level-header">
                <div class="level-badge combined-badge">âœ¦</div>
                <div>
                  <h4>Combined Caption</h4>
                  <p>Final combined description from visual + knowledge</p>
                </div>
              </div>
              <div class="bilingual-fields">
                <div class="lang-field">
                  <span class="lang-label">ðŸ‡¬ðŸ‡§ EN</span>
                  <mat-form-field appearance="outline">
                    <textarea matInput [(ngModel)]="captionData.combined_caption" rows="4"
                      placeholder="Combined description incorporating visual and knowledge levels..."></textarea>
                  </mat-form-field>
                  <button mat-icon-button class="translate-btn" matTooltip="Translate EN â†’ VI"
                          (click)="translateField('combined_caption', 'en_to_vi')" [disabled]="translating">
                    <mat-icon>south</mat-icon>
                  </button>
                </div>
                <div class="lang-field">
                  <span class="lang-label">ðŸ‡»ðŸ‡³ VI</span>
                  <mat-form-field appearance="outline">
                    <textarea matInput [(ngModel)]="captionData.combined_caption_vi" rows="4"
                      placeholder="MÃ´ táº£ tá»•ng há»£p káº¿t há»£p cÃ¡c cáº¥p Ä‘á»™ visual vÃ  knowledge..."></textarea>
                  </mat-form-field>
                  <button mat-icon-button class="translate-btn" matTooltip="Translate VI â†’ EN"
                          (click)="translateField('combined_caption', 'vi_to_en')" [disabled]="translating">
                    <mat-icon>north</mat-icon>
                  </button>
                </div>
              </div>
              <div class="combine-actions">
                <button mat-stroked-button class="auto-combine-btn" (click)="autoCombineRegionAndTranslate()"
                        [disabled]="translating || !canCombineRegionCaptions()"
                        [matTooltip]="getRegionCombineTooltip()">
                  <mat-spinner *ngIf="translating" diameter="16"></mat-spinner>
                  <mat-icon *ngIf="!translating">auto_awesome</mat-icon>
                  {{ translating ? 'Processing...' : 'Auto Combine & Translate' }}
                </button>
              </div>
            </div>

            <div class="caption-actions">
              <button mat-raised-button class="primary-btn" (click)="saveCaption()">
                <mat-icon>save</mat-icon> Save Caption
              </button>
            </div>
          </div>
        </ng-container>

        <!-- No selection placeholder -->
        <div *ngIf="!selectedSegment" class="caption-header">
          <h3>Select a segment to add captions</h3>
        </div>
      </div>

      <!-- Resize Divider -->
      <div class="resize-divider" (mousedown)="startPanelResize($event)"></div>
      <!-- Segments & Regions Panel -->
      <div class="caption-sidebar" [style.width.px]="panelWidth">
        <div class="panel-header">
          <h3>Segments</h3>
        </div>
        <div class="caption-segments">
          <div *ngFor="let seg of segments; let i = index" class="caption-seg-group">
            <div class="caption-seg-header" [class.active]="selectedSegment?.id === seg.id"
              (click)="selectSegmentForCaption(seg)">
              <div class="seg-color" [style.background]="getSegmentColor(i)"></div>
              <span>{{ seg.name }}</span>
              <mat-icon>{{ selectedSegment?.id === seg.id ? 'expand_less' : 'expand_more' }}</mat-icon>
            </div>
            <div class="caption-regions" *ngIf="selectedSegment?.id === seg.id">
              <div *ngFor="let region of regions"
                class="caption-region-item"
                [class.active]="selectedRegion?.id === region.id"
                (click)="selectRegionForCaption(region)">
                <div class="region-color-dot" [style.background]="region.color"></div>
                <span>{{ region.label }}</span>
                <div class="right-group">
                  <span *ngIf="region.category_name" class="region-cat-badge">{{ region.category_name }}</span>
                  <mat-icon *ngIf="region.caption" class="has-caption-icon">check_circle</mat-icon>
                </div>
              </div>
              <div *ngIf="regions.length === 0" class="no-regions">
                No regions in this segment
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading -->
<div *ngIf="!video" class="loading-page">
  <mat-spinner diameter="40"></mat-spinner>
</div>

<!-- Reject Dialog -->
<div class="ed-dialog-overlay" *ngIf="showEditorRejectDialog" (click)="showEditorRejectDialog = false">
  <div class="ed-dialog-card" (click)="$event.stopPropagation()">
    <h2>Reject Video</h2>
    <p class="ed-dialog-subtitle">{{ video?.original_name }}</p>
    <div class="ed-textarea-wrap">
      <textarea [(ngModel)]="editorRejectComment" rows="4"
                placeholder="Describe what needs to be fixed..."></textarea>
    </div>
    <div class="ed-dialog-actions">
      <button mat-button (click)="showEditorRejectDialog = false">Cancel</button>
      <button mat-raised-button class="ed-reject-btn" (click)="rejectVideo()">
        <mat-icon>cancel</mat-icon> Reject
      </button>
    </div>
  </div>
</div>
